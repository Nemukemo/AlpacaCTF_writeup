from Crypto.Util.number import long_to_bytes, inverse
import gmpy2

# 問題文より与えられたパラメータ
n = 91102717210596990388603678426683097953697889897819753293818443119019220403217013812232251320814152567699322671590559119510246139859891156830672838769529887961956970370968572962306584295059185945752892892100975462391203805852473243296747559459800718013816237662990504689724747628304890125129146326331097856907
c1 = 84316690833236468829386139306045298111202426584048821548102362931269993141514516100633466389955824290011995159677864206138653174440904170622039293036862729884826231898868928186453091113165643576890891297150845933751243965934735328928976655465009980896153972226679588496970771925581698573227941539852081781874
c2 = 74682069306151159606579889187354529286195652598555930926994495384029865435810129236911316774977007932641783161876484392995815937986886903514990618178943843429073696833993271982336114314882872652681858748846455760309012235191324385691614015531641062111894149446939460102878320469041435024347449132388644171970
e1 = 65517
e2 = 65577

# Step 1: Common Modulus Attackの準備
# e1*s1 + e2*s2 = gcd(e1, e2) となる s1, s2 を求める
g, s1, s2 = gmpy2.gcdext(e1, e2)

print(f"GCD(e1, e2) = {g}") # 3 になるはず

# Step 2: m^3 mod n を計算する
# c1^s1 * c2^s2 = (m^e1)^s1 * (m^e2)^s2 = m^(e1*s1 + e2*s2) = m^3 (mod n)
# s1, s2のどちらかは負になるため、モジュラ逆数を使って計算する
if s1 < 0:
    c1_term = pow(inverse(c1, n), -s1, n)
else:
    c1_term = pow(c1, s1, n)

if s2 < 0:
    c2_term = pow(inverse(c2, n), -s2, n)
else:
    c2_term = pow(c2, s2, n)

m_cubed = (c1_term * c2_term) % n

# Step 3: m = n - delta の関係を利用して delta を求める
# m^3 = (n - delta)^3 = n^3 - ... - delta^3 = -delta^3 (mod n)
# つまり m_cubed = n - delta^3
delta_cubed = n - m_cubed

# 整数としての3乗根を計算
delta, exact = gmpy2.iroot(delta_cubed, 3)

if exact:
    print("[+] Perfect cube found!")
    # Step 4: m を復元してフラグを表示
    m = n - int(delta)
    flag_bytes = long_to_bytes(m)
    # フラグは末尾にある
    print(f"Recovered Message: {flag_bytes}")
    try:
        # 必要な部分だけ抽出（flag形式の部分を探す）
        print(f"Flag: {flag_bytes[-40:].decode('utf-8', errors='ignore')}") 
    except:
        pass
else:
    print("[-] Failed to compute cube root.")